<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Member Registration - Elite Gym Dashboard</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script src="../js/auth.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/realtime-sync.js"></script>
    <style>
        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .admin-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin-left: auto;
        }
    </style>
</head>
<body class="bg-background min-h-screen">
    <!-- Global Header Navigation -->
    <header class="bg-gradient-to-r from-purple-600 to-blue-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
                            <path d="M8 11h8v2H8z"/>
                            <path d="M10 7h4v2h-4z"/>
                            <path d="M10 15h4v2h-4z"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-xl font-semibold text-white">Elite Gym</h1>
                        <p class="text-xs text-gray-200">Dashboard</p>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex space-x-8">
                    <a href="member_registration.html" class="text-white font-medium px-3 py-2 rounded-md bg-white bg-opacity-20">
                        Registration
                    </a>
                    <a href="member_management_dashboard.html" class="text-white hover:text-gray-200 transition-colors px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-10">
                        Dashboard
                    </a>
                    <a href="payment_defaulters.html" class="text-white hover:text-gray-200 transition-colors px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-10">
                        Defaulters
                    </a>
                    <a href="reports_and_analytics.html" class="text-white hover:text-gray-200 transition-colors px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-10">
                        Reports
                    </a>
                </nav>

                <!-- Admin Info & Logout -->
                <div class="hidden md:flex items-center space-x-4">
                    <div class="admin-header">
                        <span class="text-white text-sm">Welcome, <span data-user-info>Admin</span></span>
                    </div>
                    <button data-logout class="text-white hover:text-gray-200 transition-colors px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-10">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden flex items-center space-x-2">
                    <span class="text-white text-sm" data-user-info>Admin</span>
                    <button data-logout class="text-white hover:text-gray-200 p-1">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                    <button type="button" class="text-white hover:text-gray-200 p-2" onclick="toggleMobileMenu()">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation -->
            <div id="mobile-menu" class="md:hidden hidden border-t border-white border-opacity-20">
                <div class="px-2 pt-2 pb-3 space-y-1">
                    <a href="member_registration.html" class="text-white font-medium block px-3 py-2 rounded-md bg-white bg-opacity-20">
                        Registration
                    </a>
                    <a href="member_management_dashboard.html" class="text-white hover:text-gray-200 block px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-10">
                        Dashboard
                    </a>
                    <a href="payment_defaulters.html" class="text-white hover:text-gray-200 block px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-10">
                        Defaulters
                    </a>
                    <a href="reports_and_analytics.html" class="text-white hover:text-gray-200 block px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-10">
                        Reports
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <nav class="flex" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
                <li>
                    <div class="flex items-center">
                        <svg class="h-4 w-4 text-text-secondary" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                        </svg>
                        <span class="ml-2 text-sm text-text-secondary">Registration</span>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="h-4 w-4 text-text-secondary" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="ml-2 text-sm font-medium text-primary">New Member</span>
                    </div>
                </li>
            </ol>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        <div class="bg-surface rounded-lg shadow-card p-6 lg:p-8">
            <!-- Header -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold text-text-primary mb-2">Member Registration</h2>
                <p class="text-text-secondary">Add a new member to your gym with comprehensive details and automatic membership setup.</p>
            </div>

            <!-- Registration Form -->
            <form id="memberRegistrationForm" class="space-y-8">
                <!-- Personal Information Section -->
                <div class="bg-surface rounded-lg p-6 border border-border">
                    <h3 class="text-lg font-medium text-text-primary mb-6 flex items-center">
                        <svg class="h-5 w-5 text-primary mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        Personal Information
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Admission Number -->
                        <div>
                            <label for="admissionNumber" class="block text-sm font-medium text-text-primary mb-2">
                                Admission Number <span class="text-error">*</span>
                            </label>
                            <input type="text" id="admissionNumber" name="admissionNumber" required class="form-input w-full" placeholder="e.g., GM2025001" />
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>

                        <!-- Full Name -->
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-text-primary mb-2">
                                Full Name <span class="text-error">*</span>
                            </label>
                            <input type="text" id="fullName" name="fullName" required class="form-input w-full" placeholder="Enter full name" />
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>

                        <!-- Mobile Number -->
                        <div>
                            <label for="mobileNumber" class="block text-sm font-medium text-text-primary mb-2">
                                Mobile Number <span class="text-error">*</span>
                            </label>
                            <input type="tel" id="mobileNumber" name="mobileNumber" required class="form-input w-full" placeholder="+91 98765 43210" pattern="(\+91[\s\-]?)?[6-9]\d{9}" title="Enter a valid Indian mobile number" />
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>

                        <!-- Sex -->
                        <div>
                            <label for="sex" class="block text-sm font-medium text-text-primary mb-2">
                                Sex <span class="text-error">*</span>
                            </label>
                            <select id="sex" name="sex" required class="form-input w-full">
                                <option value>Select sex</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>

                        <!-- Date of Birth -->
                        <div>
                            <label for="dateOfBirth" class="block text-sm font-medium text-text-primary mb-2">
                                Date of Birth <span class="text-error">*</span>
                            </label>
                            <input type="date" id="dateOfBirth" name="dateOfBirth" required class="form-input w-full" />
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>

                        <!-- Blood Group -->
                        <div>
                            <label for="bloodGroup" class="block text-sm font-medium text-text-primary mb-2">
                                Blood Group
                            </label>
                            <select id="bloodGroup" name="bloodGroup" class="form-input w-full">
                                <option value>Select blood group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>

                    <!-- Address -->
                    <div class="mt-6">
                        <label for="address" class="block text-sm font-medium text-text-primary mb-2">
                            Address <span class="text-error">*</span>
                        </label>
                        <textarea id="address" name="address" rows="3" required class="form-input w-full resize-none" placeholder="Enter complete address (e.g., A-123, Sector 15, Noida, Uttar Pradesh 201301)"></textarea>
                        <div class="error-message hidden text-error text-sm mt-1"></div>
                    </div>
                </div>

                <!-- Emergency Contact Section -->
                <div class="bg-surface rounded-lg p-6 border border-border">
                    <h3 class="text-lg font-medium text-text-primary mb-6 flex items-center">
                        <svg class="h-5 w-5 text-secondary mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        Emergency Contact
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Emergency Contact Name -->
                        <div>
                            <label for="emergencyContactName" class="block text-sm font-medium text-text-primary mb-2">
                                Contact Name <span class="text-error">*</span>
                            </label>
                            <input type="text" id="emergencyContactName" name="emergencyContactName" required class="form-input w-full" placeholder="Emergency contact name" />
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>

                        <!-- Relationship -->
                        <div>
                            <label for="emergencyRelationship" class="block text-sm font-medium text-text-primary mb-2">
                                Relationship <span class="text-error">*</span>
                            </label>
                            <select id="emergencyRelationship" name="emergencyRelationship" required class="form-input w-full">
                                <option value>Select relationship</option>
                                <option value="Parent">Parent</option>
                                <option value="Spouse">Spouse</option>
                                <option value="Sibling">Sibling</option>
                                <option value="Child">Child</option>
                                <option value="Friend">Friend</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>

                        <!-- Emergency Contact Number -->
                        <div>
                            <label for="emergencyContactNumber" class="block text-sm font-medium text-text-primary mb-2">
                                Contact Number <span class="text-error">*</span>
                            </label>
                            <input type="tel" id="emergencyContactNumber" name="emergencyContactNumber" required class="form-input w-full" placeholder="+91 98765 12345" pattern="(\+91[\s\-]?)?[6-9]\d{9}" title="Enter a valid Indian mobile number" />
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>
                    </div>
                </div>

                <!-- Membership Details Section -->
                <div class="bg-surface rounded-lg p-6 border border-border">
                    <h3 class="text-lg font-medium text-text-primary mb-6 flex items-center">
                        <svg class="h-5 w-5 text-primary mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 9a2 2 0 10-4 0v5a2 2 0 01-2 2h6m-6-4h4m8 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Membership Details
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Membership Type -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-text-primary mb-4">
                                Membership Type <span class="text-error">*</span>
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="relative flex items-center p-4 bg-surface border border-border rounded-lg cursor-pointer hover:bg-surface-hover transition-colors">
                                    <input type="radio" name="membershipType" value="Monthly" class="sr-only" onchange="updateMembershipDetails()" />
                                    <div class="flex items-center">
                                        <div class="radio-indicator w-4 h-4 border-2 border-border rounded-full mr-3 flex items-center justify-center">
                                            <div class="w-2 h-2 bg-primary rounded-full hidden"></div>
                                        </div>
                                        <div>
                                            <div class="font-medium text-text-primary">Monthly</div>
                                            <div class="text-sm text-text-secondary">₹600/month</div>
                                        </div>
                                    </div>
                                </label>
                                <label class="relative flex items-center p-4 bg-surface border border-border rounded-lg cursor-pointer hover:bg-surface-hover transition-colors">
                                    <input type="radio" name="membershipType" value="Annual" class="sr-only" onchange="updateMembershipDetails()" />
                                    <div class="flex items-center">
                                        <div class="radio-indicator w-4 h-4 border-2 border-border rounded-full mr-3 flex items-center justify-center">
                                            <div class="w-2 h-2 bg-primary rounded-full hidden"></div>
                                        </div>
                                        <div>
                                            <div class="font-medium text-text-primary">Annual</div>
                                            <div class="text-sm text-text-secondary">₹6,000/year <span class="text-success font-medium">(Save ₹1,200)</span></div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>

                        <!-- Start Date -->
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-text-primary mb-2">
                                Start Date <span class="text-error">*</span>
                            </label>
                            <input type="date" id="startDate" name="startDate" required class="form-input w-full" onchange="updateEndDate()" />
                            <div class="error-message hidden text-error text-sm mt-1"></div>
                        </div>

                        <!-- End Date (Auto-calculated) -->
                        <div>
                            <label for="endDate" class="block text-sm font-medium text-text-primary mb-2">
                                End Date
                            </label>
                            <input type="date" id="endDate" name="endDate" readonly class="form-input w-full bg-surface-hover cursor-not-allowed" />
                            <div class="text-xs text-text-secondary mt-1">Automatically calculated based on membership type</div>
                        </div>
                    </div>

                    <!-- Membership Summary -->
                    <div id="membershipSummary" class="mt-6 p-4 bg-surface rounded-lg border border-border hidden">
                        <h4 class="font-medium text-text-primary mb-2">Membership Summary</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-text-secondary">Type:</span>
                                <span id="summaryType" class="font-medium text-text-primary ml-2">-</span>
                            </div>
                            <div>
                                <span class="text-text-secondary">Duration:</span>
                                <span id="summaryDuration" class="font-medium text-text-primary ml-2">-</span>
                            </div>
                            <div>
                                <span class="text-text-secondary">Total Cost:</span>
                                <span id="summaryCost" class="font-medium text-primary ml-2">-</span>
                            </div>
                            <div>
                                <span class="text-text-secondary">Next Payment:</span>
                                <span id="summaryNextPayment" class="font-medium text-text-primary ml-2">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex flex-col sm:flex-row justify-between items-center pt-6 border-t border-border">
                    <div class="text-sm text-text-secondary mb-4 sm:mb-0">
                        <span class="text-error">*</span> Required fields
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="resetForm()" class="px-6 py-2 border border-border text-text-secondary rounded-md hover:bg-surface-hover transition-colors">
                            Reset Form
                        </button>
                        <button type="submit" id="submitButton" class="btn-primary px-8 py-2 flex items-center">
                            <span id="submitText">Register Member</span>
                            <svg id="loadingIcon" class="hidden animate-spin ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-surface rounded-lg shadow-modal max-w-md w-full p-6 animate-fade-in">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-medium text-text-primary">Registration Successful!</h3>
                    </div>
                </div>
                <p class="text-text-secondary mb-6">
                    Member has been successfully registered and payment history initialized.
                </p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeSuccessModal()" class="px-4 py-2 border border-border text-text-secondary rounded-md hover:bg-surface-hover transition-colors">
                        Close
                    </button>
                    <button onclick="markFirstPayment()" class="btn-secondary px-4 py-2">
                        Mark First Payment
                    </button>
                    <a href="member_management_dashboard.html" class="btn-primary px-4 py-2 inline-block text-center">
                        View Dashboard
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            updateEndDate();
            
            // Generate next admission number
            generateAdmissionNumber();
        });

        // Toggle mobile menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        }

        // Generate admission number
        function generateAdmissionNumber() {
            const year = new Date().getFullYear();
            const members = JSON.parse(localStorage.getItem('elite_gym_members') || '[]');
            const nextNumber = (members.length + 1).toString().padStart(3, '0');
            document.getElementById('admissionNumber').value = `GM${year}${nextNumber}`;
        }

        // Update radio button styling
        document.querySelectorAll('input[name="membershipType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.radio-indicator').forEach(indicator => {
                    indicator.querySelector('div').classList.add('hidden');
                    indicator.classList.remove('border-primary');
                    indicator.classList.add('border-gray-300');
                });
                
                if (this.checked) {
                    const indicator = this.parentElement.querySelector('.radio-indicator');
                    indicator.querySelector('div').classList.remove('hidden');
                    indicator.classList.add('border-primary');
                    indicator.classList.remove('border-gray-300');
                }
            });
        });

        // Update membership details
        function updateMembershipDetails() {
            const membershipType = document.querySelector('input[name="membershipType"]:checked')?.value;
            const summary = document.getElementById('membershipSummary');
            
            if (membershipType) {
                summary.classList.remove('hidden');
                
                const isMonthly = membershipType === 'Monthly';
                document.getElementById('summaryType').textContent = membershipType;
                document.getElementById('summaryDuration').textContent = isMonthly ? '1 Month' : '12 Months';
                document.getElementById('summaryCost').textContent = isMonthly ? '₹600' : '₹6,000';
                
                const startDate = document.getElementById('startDate').value;
                if (startDate) {
                    const nextPayment = new Date(startDate);
                    nextPayment.setMonth(nextPayment.getMonth() + (isMonthly ? 1 : 12));
                    document.getElementById('summaryNextPayment').textContent = nextPayment.toLocaleDateString();
                }
                
                updateEndDate();
            } else {
                summary.classList.add('hidden');
            }
        }

        // Update end date based on membership type and start date
        function updateEndDate() {
            const startDate = document.getElementById('startDate').value;
            const membershipType = document.querySelector('input[name="membershipType"]:checked')?.value;
            
            if (startDate && membershipType) {
                const start = new Date(startDate);
                const end = new Date(start);
                
                if (membershipType === 'Monthly') {
                    end.setMonth(end.getMonth() + 1);
                } else {
                    end.setFullYear(end.getFullYear() + 1);
                }
                
                document.getElementById('endDate').value = end.toISOString().split('T')[0];
                
                // Update summary if visible
                const summary = document.getElementById('membershipSummary');
                if (!summary.classList.contains('hidden')) {
                    document.getElementById('summaryNextPayment').textContent = end.toLocaleDateString();
                }
            }
        }

        // Format Indian phone number as user types
        function formatIndianPhoneNumber(input) {
            let value = input.value.replace(/\D/g, ''); // Remove all non-digits
            
            // If starts with 91, add +91 prefix
            if (value.startsWith('91') && value.length > 2) {
                value = value.substring(2);
                value = '+91 ' + value;
            } else if (value.length > 0 && !value.startsWith('+91')) {
                // If it's a 10-digit number starting with 6-9, add +91
                if (value.length === 10 && /^[6-9]/.test(value)) {
                    value = '+91 ' + value;
                } else if (value.length > 10) {
                    // Limit to 10 digits for Indian numbers
                    value = value.substring(0, 10);
                    if (/^[6-9]/.test(value)) {
                        value = '+91 ' + value;
                    }
                }
            }
            
            // Format the number with spaces for readability
            if (value.startsWith('+91 ') && value.length > 4) {
                const number = value.substring(4);
                if (number.length > 5) {
                    value = '+91 ' + number.substring(0, 5) + ' ' + number.substring(5);
                }
            }
            
            input.value = value;
        }

        // Add event listeners for phone number formatting
        document.addEventListener('DOMContentLoaded', function() {
            const mobileInput = document.getElementById('mobileNumber');
            const emergencyInput = document.getElementById('emergencyContactNumber');
            
            mobileInput.addEventListener('input', function() {
                formatIndianPhoneNumber(this);
            });
            
            emergencyInput.addEventListener('input', function() {
                formatIndianPhoneNumber(this);
            });
        });

        // Form validation
        function validateForm() {
            let isValid = true;
            const requiredFields = [
                'admissionNumber', 'fullName', 'mobileNumber', 'sex', 
                'dateOfBirth', 'address', 'emergencyContactName', 
                'emergencyRelationship', 'emergencyContactNumber', 'startDate'
            ];
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(msg => {
                msg.classList.add('hidden');
                msg.textContent = '';
            });
            
            // Validate required fields
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (!field.value.trim()) {
                    showError(fieldName, 'This field is required');
                    isValid = false;
                }
            });
            
            // Validate membership type
            const membershipType = document.querySelector('input[name="membershipType"]:checked');
            if (!membershipType) {
                showError('membershipType', 'Please select a membership type');
                isValid = false;
            }
            
            // Validate phone numbers (Indian format)
            const phoneRegex = /^(\+91[\s\-]?)?[6-9]\d{9}$/;
            const mobileNumber = document.getElementById('mobileNumber').value;
            const emergencyNumber = document.getElementById('emergencyContactNumber').value;
            
            if (mobileNumber && !phoneRegex.test(mobileNumber.replace(/[\s\-]/g, ''))) {
                showError('mobileNumber', 'Please enter a valid Indian mobile number (e.g., +91 98765 43210)');
                isValid = false;
            }
            
            if (emergencyNumber && !phoneRegex.test(emergencyNumber.replace(/[\s\-]/g, ''))) {
                showError('emergencyContactNumber', 'Please enter a valid Indian mobile number (e.g., +91 98765 43210)');
                isValid = false;
            }
            
            // Check for duplicate admission number
            const admissionNumber = document.getElementById('admissionNumber').value;
            const members = JSON.parse(localStorage.getItem('elite_gym_members') || '[]');
            if (members.some(member => member.admissionNumber === admissionNumber)) {
                showError('admissionNumber', 'This admission number already exists');
                isValid = false;
            }
            
            return isValid;
        }

        // Show error message
        function showError(fieldName, message) {
            const field = document.getElementById(fieldName);
            let errorElement;
            
            if (fieldName === 'membershipType') {
                errorElement = document.querySelector('input[name="membershipType"]').closest('.md\\:col-span-2').querySelector('.error-message');
            } else {
                errorElement = field.parentElement.querySelector('.error-message');
            }
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
            
            field.classList.add('border-error');
            setTimeout(() => field.classList.remove('border-error'), 3000);
        }

        // Reset form
        function resetForm() {
            document.getElementById('memberRegistrationForm').reset();
            document.getElementById('membershipSummary').classList.add('hidden');
            document.querySelectorAll('.error-message').forEach(msg => {
                msg.classList.add('hidden');
                msg.textContent = '';
            });
            
            // Reset radio button styling
            document.querySelectorAll('.radio-indicator').forEach(indicator => {
                indicator.querySelector('div').classList.add('hidden');
                indicator.classList.remove('border-primary');
                indicator.classList.add('border-gray-300');
            });
            
            // Set default values
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            generateAdmissionNumber();
        }

        // Handle form submission
        document.getElementById('memberRegistrationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            // Show loading state
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            const loadingIcon = document.getElementById('loadingIcon');
            
            submitButton.disabled = true;
            submitText.textContent = 'Registering...';
            loadingIcon.classList.remove('hidden');
            
            // Simulate API call
            setTimeout(() => {
                // Collect form data
                const formData = new FormData(this);
                const memberData = {
                    id: Date.now(),
                    admissionNumber: formData.get('admissionNumber'),
                    fullName: formData.get('fullName'),
                    mobileNumber: formData.get('mobileNumber'),
                    sex: formData.get('sex'),
                    dateOfBirth: formData.get('dateOfBirth'),
                    bloodGroup: formData.get('bloodGroup'),
                    address: formData.get('address'),
                    emergencyContactName: formData.get('emergencyContactName'),
                    emergencyRelationship: formData.get('emergencyRelationship'),
                    emergencyContactNumber: formData.get('emergencyContactNumber'),
                    membershipType: formData.get('membershipType'),
                    startDate: formData.get('startDate'),
                    endDate: document.getElementById('endDate').value,
                    registrationDate: new Date().toISOString().split('T')[0],
                    status: 'Active',
                    paymentHistory: generatePaymentHistory(formData.get('membershipType'), formData.get('startDate'))
                };

                // Save to localStorage
                const members = JSON.parse(localStorage.getItem('elite_gym_members') || '[]');
                members.push(memberData);
                localStorage.setItem('elite_gym_members', JSON.stringify(members));
                localStorage.setItem('currentNewMember', JSON.stringify(memberData));

                // Sync with real-time database
                if (window.realtimeSync) {
                    window.realtimeSync.addMember(memberData);
                }

                // Show success modal
                document.getElementById('successModal').classList.remove('hidden');
                
                // Reset loading state
                submitButton.disabled = false;
                submitText.textContent = 'Register Member';
                loadingIcon.classList.add('hidden');
            }, 1500);
        });

        // Reset form
        function resetForm() {
            document.getElementById('memberRegistrationForm').reset();
            document.getElementById('membershipSummary').classList.add('hidden');
            document.querySelectorAll('.error-message').forEach(msg => {
                msg.classList.add('hidden');
                msg.textContent = '';
            });
            
            // Reset radio button styling
            document.querySelectorAll('.radio-indicator').forEach(indicator => {
                indicator.querySelector('div').classList.add('hidden');
                indicator.classList.remove('border-primary');
                indicator.classList.add('border-gray-300');
            });
            
            // Set default values
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            generateAdmissionNumber();
        }

        // Generate payment history
        function generatePaymentHistory(membershipType, startDate) {
            const history = [];
            const start = new Date(startDate);
            const isMonthly = membershipType === 'Monthly';
            const amount = isMonthly ? 600 : 6000;
            
            if (isMonthly) {
                // Create 12 monthly payments
                for (let i = 0; i < 12; i++) {
                    const paymentDate = new Date(start);
                    paymentDate.setMonth(paymentDate.getMonth() + i);
                    
                    history.push({
                        id: Date.now() + i,
                        dueDate: paymentDate.toISOString().split('T')[0],
                        amount: amount,
                        status: 'Pending',
                        paidDate: null,
                        method: null
                    });
                }
            } else {
                // Create annual payment
                history.push({
                    id: Date.now(),
                    dueDate: start.toISOString().split('T')[0],
                    amount: amount,
                    status: 'Pending',
                    paidDate: null,
                    method: null
                });
            }
            
            return history;
        }

        // Close success modal
        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            resetForm();
        }

        // Mark first payment
        function markFirstPayment() {
            const memberData = JSON.parse(localStorage.getItem('currentNewMember'));
            if (memberData) {
                // Update first payment status
                memberData.paymentHistory[0].status = 'Paid';
                memberData.paymentHistory[0].paidDate = new Date().toISOString().split('T')[0];
                memberData.paymentHistory[0].method = 'Cash';
                
                // Update in storage
                const members = JSON.parse(localStorage.getItem('elite_gym_members') || '[]');
                const memberIndex = members.findIndex(m => m.id === memberData.id);
                if (memberIndex !== -1) {
                    members[memberIndex] = memberData;
                    localStorage.setItem('elite_gym_members', JSON.stringify(members));
                }
                
                // Show confirmation
                alert('First payment marked as paid successfully!');
                closeSuccessModal();
            }
        }

        // Format phone number input
        document.getElementById('mobileNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
            } else if (value.length >= 3) {
                value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            }
            e.target.value = value;
        });

        document.getElementById('emergencyContactNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
            } else if (value.length >= 3) {
                value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            }
            e.target.value = value;
        });
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>